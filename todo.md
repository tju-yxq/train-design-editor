# 高铁设计图纸多轮编辑系统 - 待办清单

## 核心功能

- [x] 图片上传和显示功能
- [x] 基础图片加载(https://gitee.com/Yu-xinqiang0413/images/raw/master/img/image-20260211164812591.png)
- [x] 自然语言输入框
- [x] 参数提取和解析系统(支持车头长度、车头高度、驾驶室高度、流线型曲率、车窗尺寸等)
- [x] 阿里云百链 API集成(图像编辑能力)
- [x] 修改历史记录功能
- [x] 参数状态管理系统
- [ ] 图片对比视图(原图vs修改后)
- [x] 加载状态提示(5-20秒生成时间)

## 数据库设计

- [x] 设计编辑历史表
- [x] 设计参数状态表
- [x] 实现数据库迁移

## 后端API

- [x] 实现自然语言参数解析接口
- [x] 集成阿里云百链API
- [x] 实现图像编辑接口
- [x] 实现历史记录查询接口
- [x] 实现参数状态管理接口

## 前端界面

- [x] 设计整体布局
- [x] 实现图片展示组件
- [x] 实现自然语言输入组件
- [x] 实现参数显示面板
- [x] 实现历史记录列表
- [ ] 实现图片对比视图
- [x] 实现加载状态动画

## 测试

- [x] 编写后端单元测试
- [x] 测试自然语言解析准确性
- [ ] 测试图像生成功能
- [ ] 测试历史记录功能
- [ ] 端到端功能测试

## 修复和改进

- [x] 修复阿里云百炼 API图像编辑URL错误(使用Base64编码)
- [x] 补充完整的参数列表(根据用户提供的文档)
- [x] 测试图像编辑功能是否正常工作

## API访问权限问题

- [x] 编写阿里云百炼API测试脚本
- [x] 验证API Key是否有效
- [x] 验证模型访问权限
- [x] 修复Model access denied错误

## 更新API配置

- [x] 更新模型为qwen-image-edit-max
- [x] 更新API Key为新的密钥
- [x] 测试新模型是否可访问
- [x] 验证图像编辑功能正常工作

## 分离API Key配置

- [x] 添加独立的图像编辑API Key环境变量
- [x] 保持原有文本API Key不变
- [x] 更新图像编辑代码使用新的API Key
- [x] 测试图像编辑功能

## 优化图像编辑功能

- [x] 优化提示词,确保保持完整列车图纸(不只是车头)
- [x] 在设计图纸区域添加占位符
- [x] 添加图片生成加载状态显示
- [x] 测试优化后的图像编辑效果(已生成完整列车图纸)

## 修复参数更新错误

- [x] 修复参数解析逻辑,将字符串表达式转换为实际数值
- [x] 测试参数更新功能(所有测试通过)
- [x] 验证数据库更新正确

## 实现渐进式图纸编辑

- [x] 更新基础图片为新的高铁图片
- [x] 修改编辑逻辑:每次基于上一次生成的图纸进行修改
- [x] 修改前端实时更新当前参数显示(每3秒轮询)
- [ ] 添加"重置到基础图片"功能(可选,用户可以手动删除历史记录)
- [x] 测试渐进式编辑流程(所有测试通过)

## 优化图像编辑提示词

- [x] 修改提示词,强调保持原图完整性(正视图+侧视图)
- [x] 强调只修改用户指定的具体部分
- [x] 禁止整体缩放或改变图像布局
- [x] 测试优化后的图像生成效果(等待用户验证)

## 更新基础图片并强化提示词

- [x] 上传新的CR450AF正视图侧视图原图
- [x] 更新BASE_IMAGE_URL配置
- [x] 强化提示词,特别强调保持正视图和侧视图都不消失
- [x] 测试图像编辑效果(等待用户验证)

## 修复关键问题

- [x] 修复图像编辑超时问题(从60秒增加到180秒)
- [x] 修复React DOM渲染错误(使用稳定的复合key值,添加空值检查)
- [x] 实现分级修改历史管理(设计会话概念)
- [x] 添加"新建会话"功能,从基础图片重新开始
- [x] 测试所有修复功能

## 实现分级修改历史管理

- [x] 在数据库中添加design_sessions表
- [x] 修改edit_history表添加session_id外键
- [x] 在db.ts中添加会话相关的数据库操作函数
- [x] 在routers.ts中添加会话管理API(创建会话、获取会话、切换会话)
- [x] 修改submitEdit逻辑,自动关联到活跃会话
- [x] 在前端添加会话管理UI(新建会话按钮、会话列表、切换会话)
- [x] 修改历史记录查询逻辑,只显示当前会话的记录
- [x] 测试会话管理功能(所有测试通过)

## 修复新发现的问题

- [x] 修复SQL更新语句错误(添加空对象检查,避免空SET子句)
- [x] 修复图像编辑逻辑,确保基于当前会话的最新图片(传入sessionId参数)
- [x] 测试修复后的完整流程(服务器重启成功,等待用户验证)
